# VibeSync: Strict AI Engineering Constraints (v0.4 Go)

All code generated for the VibeSync project (Unity, Blender, and Go Orchestrator) must adhere to these absolute mandates.

---

## üõ´ Pre-Flight Protocol
Before initiating any mutation or code change, you **MUST** verify the action against:
0.  **Adversarial Pre-flight**: Run `python3 scripts/preflight.py` to auto-resolve zombie engines or port conflicts.
1.  **`metadata/VIBE_CORE_LOGIC.md`**: Ensure the invariant laws are upheld.
2.  **`metadata/ALLOWED_OPERATIONS.md`**: Confirm the tool passes the Litmus Test for verification.
3.  **`FAILURE_MODES.md`**: Pre-calculate the rollback path for the specific mutation.
4.  **`submit_intent`**: Every operation MUST be preceded by a formal intent submission with Rationale.

---

## üèóÔ∏è The ISA Mandate (Instruction Set Architecture)
1.  **Tool Supremacy**: Every system capability MUST be expressed as a numbered ISA tool (1-32). If a function is not a tool, it does not exist.
2.  **Intent-to-State Pipeline**: Every mutation MUST follow the formal lifecycle: `submit_intent` -> `validate_intent` -> `begin_atomic_operation` -> [Mutation] -> `verify_engine_state` -> `commit_atomic_operation`.
3.  **Strict Serializability**: The Orchestrator enforces a total order of intents. Operation B is only processed after Operation A is finalized (Committed or Rolled Back). No interleaving of mutations is permitted.
4.  **Monotonic Causality**: All sub-operations MUST carry the `ParentID` of their originating transaction and a unique `MonotonicID` generated by the Go Kernel. Monotonic counters are the sole authority for ordering.

## üé≠ Tone & Psychological Defense
1.  **Clinical Objectivity**: Use clinical, direct language. No urgency, no emotional framing, and no implied necessity.
2.  **Explicit Uncertainty**: If a request borders on the unknowable, use the **Epistemic Refusal** protocol (`epistemic_refusal`). Never "guess" a success.

## üõ†Ô∏è Toolchain Version Authority
1.  **Strict Pinning**: Adapters must report exact version hashes (Blender + Unity).
2.  **Handshake Requirement**: Every session MUST begin with `handshake_init` to rotate session tokens.
3.  **Refusal on Drift**: Any minor version mismatch or generation drift (detected via heartbeat) results in a `PANIC` state and lock of all hierarchies.

## ‚öñÔ∏è The Referee Mental Model (v0.4)

1.  **Assume the Editor Lies**: Never trust a "Success" message from Unity or Blender. 
2.  **Intent over Operation**: Do not bridge *how* a change happens; bridge *what* the final state must be.
3.  **Law of Independent Verification**: Every mutation MUST be followed by an independent state-read (`read_engine_state` or `verify_engine_state`) to prove reality matches intent.
4.  **Freeze-Window Policy**: During mutation, the Orchestrator assumes context is locked. Any external change during this window invalidates the transaction.

## üõ°Ô∏è Core Security & Safety Mandates

1.  **Zero Trust Authority**: All AI-generated code is untrustworthy. Authority resides exclusively in the **Go Orchestrator**.
2.  **Adapter Isolation**: Adapters are untrusted "dumb limbs." A compromise of an adapter triggers immediate session revocation. The Orchestrator assumes adapters may lie or be hijacked.
3.  **Hard Execution Bans**: 
    *   No Reflection or dynamic code execution in Adapters.
    *   No Shell/Process spawning (e.g. `os.system`).
    *   No Non-localhost network access.
4.  **Whitelisted APIs**: Only use approved Go SDK, Blender (`bpy`), and Unity (`UnityEditor`) calls.
5.  **Single API Layer**: All mutations MUST go through the `vibe-mcp-server`. No direct direct access to engine internals from raw AI scripts.
6.  **Numerical Safety**: All transforms and material deltas must pass the `auditPayload` check for NaN/Inf.
7.  **Git LFS awareness**: Large binary assets (Unity/Blender) are tracked via Git LFS. Do not attempt direct parsing of these files.

---

## üèóÔ∏è Architectural Constraints

6.  **Read-Before-Write**: Mutations follow the sequence: **Inspect ‚Üí Validate ‚Üí Mutate ‚Üí Verify**.
7.  **Monotonic Generations**: Both engines are tracked via generation counters. Any drift triggers an immediate **PANIC**.
8.  **Deterministic ID Mapping**: Objects must be mapped via the `global_id_map`. No "best-guess" renaming.
9.  **Atomic Sync**: Multi-stage mutations MUST use the sandboxed transfer pipeline (`sync_asset_atomic`) with auto-rollback.
10. **Split Architecture (Unity/Blender)**: Servers must use a separate listener thread and marshal commands to the Main Thread.
11. **Freeze-Proof Discipline**: Never block the engine main thread. All I/O, heartbeats, and asset transfers MUST be backgrounded or async with strict timeouts (1000ms).

---

## üî≠ Engineering Discipline

11. **Idempotence**: All operations must be safe to repeat.
12. **Numerical Sanitization**: All incoming data must be scrubbed for numerical instability.
13. **Fail Fast & Explicitly**: Propagate exceptions immediately. Never "swallow" a failure.
14. **Workspace Hygiene**: All temporary files, diagnostics, and state must be stored in the `.vibesync/` directory.
15. **Circuit Breaker**: The heartbeat goroutine is the final authority on engine liveness (5s interval).

---

## üõë Enforcement & Kill Switch

*   **Mechanical Review**: Any code bypassing these constraints will be rejected.
*   **Panic Broadcast**: `trigger_panic` or heartbeat failure instantly locks all engine hierarchies.
*   **Audit Logging**: Every operation is journaled to the Write-Ahead Log (WAL) with a unique `tid`.